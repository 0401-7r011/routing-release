#!/bin/bash

set -e -x

bin_dir=$(dirname $0)/../bin

if uname -a | grep Darwin; then os=darwin; else os=linux; fi
curl -L -o $TMPDIR/consul-0.5.2.zip "https://dl.bintray.com/mitchellh/consul/0.5.2_${os}_amd64.zip"
unzip -o $TMPDIR/consul-0.5.2.zip -d ./${bin_dir}
rm $TMPDIR/consul-0.5.2.zip

pushd src/github.com/coreos/etcd
  go install .
popd

export PATH=$PATH:$PWD/bin

if [ -n "$PACKAGE" ]; then
  ginkgo -r -p "$@" "./src/${PACKAGE}"
else
  pushd src/github.com/cloudfoundry-incubator/
    ginkgo -r -keepGoing -p -trace -randomizeAllSpecs -progress \
      uaa-token-fetcher cf-tcp-router tcp-emitter "$@"
  popd
fi
