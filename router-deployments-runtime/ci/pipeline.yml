groups:
- name: cf-routing-pipeline
  jobs:
    - unit
    - create-router-release
    - deploy-and-test
    - create-final-release
    - merge-master-into-develop
- name: cf-diego-deployment-pipeline
  jobs:
    - orinoco-cf-deploy
    - orinoco-diego-deploy
- name: periodic-tasks
  jobs:
    - orinoco-bosh-cleanup

resources:
- name: cf-routing-release
  type: git
  source:
    branch: develop
    uri: https://github.com/cloudfoundry-incubator/cf-routing-release.git

- name: cf-routing-release-mergeback
  type: git
  source:
    branch: develop
    uri: git@github.com:cloudfoundry-incubator/cf-routing-release.git
    private_key: {{github_private_key}}

- name: cf-routing-release-rc
  type: git
  source:
    branch: release_candidate
    uri: git@github.com:cloudfoundry-incubator/cf-routing-release.git
    private_key: {{github_private_key}}

- name: cf-routing-release-master
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry-incubator/cf-routing-release.git
    private_key: {{github_private_key}}

- name: deployments-routing
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/deployments-routing.git
    private_key: {{github_private_key}}

- name: cf-release
  type: git
  source:
    branch: runtime-passed
    uri: https://github.com/cloudfoundry/cf-release.git

- name: diego-release
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/diego-release.git

- name: router-dev-release
  type: s3
  source:
    bucket: router-release-blobs
    regexp: cf-routing-(.*).tgz
    access_key_id: {{s3_access_key_id}}
    secret_access_key: {{s3_secret_access_key}}

- name: version
  type: semver
  source:
    access_key_id: {{s3_access_key_id}}
    secret_access_key: {{s3_secret_access_key}}
    bucket: router-release-blobs
    initial_version: 0.0.0
    key: current-version
    region_name: us-east-1

- name: bosh-stemcell
  type: bosh-io-stemcell
  source:
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent

- name: orinoco-cf-deployment
  type: bosh-deployment
  source:
    target: https://52.6.225.225:25555
    username: {{bosh_username}}
    password: {{bosh_password}}
    deployment: cf-orinoco
    ignore_ssl: true

- name: orinoco-diego-deployment
  type: bosh-deployment
  source:
    target: https://52.6.225.225:25555
    username: {{bosh_username}}
    password: {{bosh_password}}
    deployment: cf-orinoco-diego
    ignore_ssl: true

- name: orinoco-router-deployment
  type: bosh-deployment
  source:
    target: https://52.6.225.225:25555
    username: {{bosh_username}}
    password: {{bosh_password}}
    deployment: cf-orinoco-routing
    ignore_ssl: true

- name: router-final-release
  type: s3
  source:
    bucket: router-final-releases
    regexp: router-(.*).tgz
    access_key_id: {{s3_access_key_id}}
    secret_access_key: {{s3_secret_access_key}}

- name: daily
  type: time
  source:
    interval: 24h

jobs:
- name: unit
  plan:
  - get: cf-routing-release
    trigger: true
  - task: unit
    file: cf-routing-release/router-deployments-runtime/ci/unit.yml

- name: create-router-release
  serial: true
  serial_groups:
    - pipeline-router
  plan:
  - aggregate:
    - get: cf-routing-release
      trigger: true
      passed:
      - unit
      params:
        submodules: all
    - get: version
      params:
        bump: minor
  - put: version
    params:
      file: version/number
  - task: create-release
    file: cf-routing-release/router-deployments-runtime/ci/create_router_dev_release.build.yml
  - put: router-dev-release
    params:
      from: create-release/cf-routing-([\d\.]+).tgz

- name: orinoco-cf-deploy
  serial: true
  serial_groups:
    - orinoco-deployment-group
  plan:
  - aggregate:
    - get: cf-routing-release
      passed:
      - unit
      params:
        submodules: none
    - get: deployments-routing
    - get: cf-release
    - get: bosh-stemcell
  - task: create-cf-release-task
    file: cf-routing-release/router-deployments-runtime/ci/create_cf_dev_release.build.yml
  - task: create-cf-manifest
    file: cf-routing-release/router-deployments-runtime/ci/create_cf_release_manifest.build.yml
    config:
      params:
        INFRASTRUCTURE: aws
        ENVIRONMENT: orinoco
  - put: orinoco-cf-deployment
    params:
      manifest: create-cf-manifest/deployment.yml
      releases: [create-cf-release-task/cf-dev-release.tgz]
      stemcells: [bosh-stemcell/*.tgz]

- name: orinoco-diego-deploy
  serial: true
  serial_groups:
    - orinoco-deployment-group
  plan:
  - aggregate:
    - get: cf-routing-release
      params:
        submodules: none
    - get: deployments-routing
    - get: diego-release
      params:
        submodules: all
    - get: cf-release
      params:
        submodules:
          - src/loggregator
    - get: bosh-stemcell
  - task: create-diego-release-task
    file: cf-routing-release/router-deployments-runtime/ci/create_diego_dev_release.build.yml
  - task: create-diego-manifest
    file: cf-routing-release/router-deployments-runtime/ci/generate_diego_deployment_manifest.build.yml
    config:
      params:
        INFRASTRUCTURE: aws
        ENVIRONMENT: orinoco
        DEPLOYMENTS_DIR: deployments-routing
  - put: orinoco-diego-deployment
    params:
      manifest: create-diego-manifest/diego-deployment.yml
      releases: [create-diego-release-task/diego-release.tgz]
      stemcells: [bosh-stemcell/*.tgz]

- name: deploy-and-test
  serial: true
  serial_groups:
    - pipeline-router
    - orinoco-deployment-group
  plan:
  - aggregate:
    - get: cf-routing-release
      passed:
      - create-router-release
      params:
        submodules: all
    - get: version
      passed:
      - create-router-release
    - get: deployments-routing
    - get: router-release-tarball
      resource: router-dev-release
      trigger: true
      passed:
        - create-router-release
    - get: bosh-stemcell
  - task: generate-deployment-manifests
    file: cf-routing-release/router-deployments-runtime/ci/generate_deployment_manifests.build.yml
    config:
      params:
        ENVIRONMENT_NAME: orinoco
        BOSH_TARGET: 52.6.225.225
        BOSH_USER: {{bosh_username}}
        BOSH_PASSWORD: {{bosh_password}}
  - put: orinoco-router-deployment
    params:
      manifest: generate-deployment-manifests/router-deployment.yml
      releases: [router-release-tarball/*.tgz]
      stemcells: [bosh-stemcell/*.tgz]
  - task: router-acceptance-tests
    file: cf-routing-release/router-deployments-runtime/ci/run_acceptance_tests.build.yml
    config:
      params:
        ACCEPTANCE_TESTS_MANIFEST: generate-deployment-manifests/router-deployment.yml
        BOSH_TARGET: 52.6.225.225
        BOSH_USER: {{bosh_username}}
        BOSH_PASSWORD: {{bosh_password}}
  - put: cf-routing-release-rc
    params:
      repository: cf-routing-release

- name: create-final-release
  serial: true
  serial_groups:
    - final-release-group
  plan:
  - aggregate:
    - get: cf-routing-release
      passed:
      - deploy-and-test
      params:
        submodules: all
    - get: version
      passed:
      - deploy-and-test
    - get: deployments-routing
  - task: create-final-release
    file: cf-routing-release/router-deployments-runtime/ci/create_router_final_release.build.yml
  - put: router-final-release
    params:
      from: create-final-release/cf-routing-([\d\.]+).tgz
  - put: cf-routing-release-master
    params:
      repository: create-final-release/cf-routing-release
      tag: version/number

- name: merge-master-into-develop
  serial: true
  serial_groups:
    - final-release-group
  plan:
  - aggregate:
    - get: cf-routing-release
      params:
        submodules: none
    - get: cf-routing-release-master
      trigger: true
      passed:
        - create-final-release
      params:
        submodules: none
  - task: merge-into-develop
    file: cf-routing-release/router-deployments-runtime/ci/merge_master_into_develop.build.yml
  - put: cf-routing-release-mergeback
    params:
      repository: merge-into-develop/cf-routing-release

- name: orinoco-bosh-cleanup
  serial: true
  serial_groups:
    - pipeline-router
  plan:
  - aggregate:
    - get: cf-routing-release
      params:
        submodules: none
    - get: daily
      trigger: true
  - task: cleanup
    file: cf-routing-release/router-deployments-runtime/ci/bosh_cleanup.build.yml
    config:
      params:
        BOSH_TARGET: 52.6.225.225
        BOSH_USER: {{bosh_username}}
        BOSH_PASSWORD: {{bosh_password}}
