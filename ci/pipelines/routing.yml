groups:
- name: routing-release-ci
  jobs:
  - upgrade-go1.x-in-routing-release
  - upgrade-go1.x-in-zdt-release
  - upgrade-cf-cli-in-routing-release
  - upgrade-dep-dependencies-in-routing-perf-release
  - routing-release-unit
  - batman-deploy-cf
  - batman-syslog-test
  - batman-cf-smoke-and-indicator-protocol-tests
  - batman-rats
  - batman-cats
  - batman-drats
  - batman-deploy-and-run-cipher-suite-tests
  - orinoco-http-perf-tests
  - diana-tcp-perf-tests
  - ci-lite-deploy-cf
  - ci-lite-cats
  - ci-lite-rats
  - jubilee-no-downtime
  - deliver-stories
  - bump-to-rc

- name: maintenance
  jobs:
  - batman-setup
  - batman-destroy
  - batman-bosh-cleanup
  - batman-delete-deployment
  - diana-setup
  - diana-destroy
  - diana-cleanup
  - orinoco-setup
  - orinoco-destroy
  - orinoco-delete-deployment
  - ci-lite-bbl-up
  - ci-lite-destroy

- name: upgrade-verification
  jobs:
  - jubilee-bbl-up
  - jubilee-no-downtime
  - jubilee-destroy

resource_types:
- name: bosh-deployment
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

resources:
#RELEASES
- name: postgres-release
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/cloudfoundry/postgres-release.git

- name: diego-release
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/cloudfoundry/diego-release.git

- name: bosh-dns-aliases-release
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/cloudfoundry/bosh-dns-aliases-release.git

- name: bosh-dns-release
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/cloudfoundry/bosh-dns-release.git

- name: bpm-release
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/cloudfoundry-incubator/bpm-release.git

- name: cipher-test-release
  type: git
  source:
    branch: master
    uri: https://github.com/cf-routing/cipher-test-release

- name: golang-release-latest
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/bosh-packages/golang-release.git

- name: routing-release
  type: git
  icon: github-box
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/routing-release.git
    private_key: ((github_private_key.private_key))

- name: cf-cli-release
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/bosh-packages/cf-cli-release.git

- name: routing-perf-release
  type: git
  icon: github-box
  source:
    branch: master
    uri: git@github.com:cloudfoundry/routing-perf-release.git
    private_key: ((github_private_key.private_key))

- name: disaster-recovery-acceptance-tests
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry-incubator/disaster-recovery-acceptance-tests.git

- name: bbr-binary-release
  type: github-release
  icon: github-face
  source:
    user: cloudfoundry-incubator
    repository: bosh-backup-and-restore
    access_token: ((github_access_token))

- name: indicator-protocol-release
  type: github-release
  icon: github-face
  source:
    user: pivotal
    repository: monitoring-indicator-protocol
    access_token: ((github_access_token))
    tag_filter: "v?(0.8\\..*)"

#REPOS
- name: deployments-routing
  type: git
  icon: github-box
  source:
    branch: master
    private_key: ((github_private_key.private_key))
    uri: git@github.com:cloudfoundry/deployments-routing.git

- name: networking-oss-deployments
  type: git
  icon: github-box
  source:
    branch: master
    private_key: ((github_private_key.private_key))
    uri: git@github.com:cloudfoundry/networking-oss-deployments.git

- name: networking-oss-tools
  type: git
  icon: github-box
  source:
    branch: master
    private_key: ((github_private_key.private_key))
    uri: git@github.com:cloudfoundry/networking-oss-tools.git

# deploy-cf-with-created-release requires a vars-files input. However we don't use vars files when we deploy
# This is just a empty dummy resource
- name: we-dont-use-vars-files
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/networking-oss-deployments.git
    private_key: ((github_private_key.private_key))

- name: routing-release-ci
  type: git
  icon: github-box
  source:
    branch: develop
    uri: git@github.com:cloudfoundry/routing-release.git
    private_key: ((github_private_key.private_key))
    paths:
      - ci

- name: bosh-bootloader
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry/bosh-bootloader.git

- name: zero-downtime-release
  type: git
  icon: github-box
  source:
    branch: master
    uri: git@github.com:cf-routing/zero-downtime-release.git
    private_key: ((github_private_key.private_key))

- name: routing-release-rc
  type: git
  source:
    branch: release-candidate
    uri: git@github.com:cloudfoundry/routing-release.git
    private_key: ((github_private_key.private_key))

# BOSH Deployments
- name: diana-tcp-perf-deployment
  type: bosh-deployment
  icon: checkbox-blank
  source:

# CF Deployment
- name: cf-deployment
  type: git
  icon: github-box
  source:
    branch: release-candidate
    uri: https://github.com/cloudfoundry/cf-deployment.git

- name: cf-deployment-release-latest
  type: git
  icon: github-box
  source:
    branch: master
    tag_filter: v*
    uri: https://github.com/cloudfoundry/cf-deployment.git

- name: cf-smoke-tests-release
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-smoke-tests-release.git

# Concourse Tasks
- name: cf-deployment-concourse-tasks
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git
    tag_filter: v10.*

- name: cf-acceptance-tests
  type: git
  icon: github-box
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-acceptance-tests

#STEMCELLS
- name: gcp-stemcell-xenial
  type: bosh-io-stemcell
  source:
    name: bosh-google-kvm-ubuntu-xenial-go_agent

#TIMERS
- name: two-hours
  type: time
  icon: clock
  source:
    interval: 120m

- name: friday-trigger
  type: time
  icon: clock
  source:
    location: America/Los_Angeles
    start: 6:00 AM
    stop: 6:01 AM
    days: [Friday]

#Tracker Projects
- name: cf-diego-networking-tracker
  type: tracker
  source:
    token: ((tracker_api_token))
    project_id: '2245594'
    tracker_url: https://www.pivotaltracker.com

jobs:
- name: upgrade-go1.x-in-routing-release
  plan:
  - in_parallel:
    - get: routing-release
    - get: golang-release-latest
      trigger: true
    - get: routing-release-ci
      params:
        submodules: none
  - task: upgrade-go1.x-in-routing-release
    file: routing-release-ci/ci/tasks/upgrade-package-in-release/task.yml
    params:
      PACKAGE: golang-1-linux
      GCP_BLOBSTORE_SERVICE_ACCOUNT_KEY: ((gcp_routing_blobstore_service_account_key))
      RELEASE: release
    input_mapping:
      release: routing-release
      package-release: golang-release-latest
  - task: save-golang-version-to-file
    file: routing-release-ci/ci/tasks/save-golang-version-to-file/task.yml
    params:
      BRANCH: develop
    input_mapping:
      release: modified-release
  - put: routing-release
    params:
      repository: modified-release

- name: upgrade-go1.x-in-zdt-release
  plan:
  - in_parallel:
    - get: zero-downtime-release
    - get: golang-release-latest
      trigger: true
    - get: routing-release-ci
      params:
        submodules: none
  - task: upgrade-go1.x-in-zero-downtime-release
    file: routing-release-ci/ci/tasks/upgrade-package-in-release/task.yml
    params:
      PACKAGE: golang-1-linux
      GCP_BLOBSTORE_SERVICE_ACCOUNT_KEY: ((gcp_routing_blobstore_service_account_key))
      RELEASE: release
      BRANCH: master
    input_mapping:
      release: zero-downtime-release
      package-release: golang-release-latest
  - put: zero-downtime-release
    params:
      repository: modified-release

- name: upgrade-dep-dependencies-in-routing-perf-release
  plan:
  - in_parallel:
    - get: routing-perf-release
    - get: routing-release-ci
      params:
        submodules: none
  - task: upgrade-dep-dependencies-in-routing-perf-release
    file: routing-release-ci/ci/tasks/upgrade-dep-dependencies-in-release/task.yml
    params:
      PACKAGES_TO_UPDATE: cpumonitor,http_route_populator,throughputramp
    input_mapping:
      release: routing-perf-release
  - put: routing-perf-release
    params:
      rebase: true
      repository: modified-release

- name: routing-release-unit
  serial: true
  plan:
  - in_parallel:
    - get: routing-release
      trigger: true
      params:
        submodules: all
  - task: unit
    timeout: 20m
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: cloudfoundry/cf-routing-pipeline
      inputs:
      - name: routing-release
      run:
        path: bash
        args:
          - -exc
          - |
            pushd "routing-release"
              source .envrc
              set +x
              export HONEYCOMB_KEY=((honeycomb_api_key))
              set -x
              scripts/run-unit-tests
            popd

- name: upgrade-cf-cli-in-routing-release
  plan:
  - in_parallel:
    - get: routing-release
    - get: cf-cli-release
      trigger: true
    - get: routing-release-ci
      params:
        submodules: none
    - get: deployments-routing
  - task: upgrade-cf-cli-in-routing-release
    file: routing-release-ci/ci/tasks/upgrade-package-in-release/task.yml
    params:
      PACKAGE: cf-cli-6-linux
      GCP_BLOBSTORE_SERVICE_ACCOUNT_KEY: ((gcp_routing_blobstore_service_account_key))
      RELEASE: release
    input_mapping:
      release: routing-release
      package-release: cf-cli-release
  - put: routing-release
    params:
      repository: modified-release

# INFRASTRUCTURE - ci-lite
- name: ci-lite-bbl-up
  serial_groups: [ci-lite]
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: routing-release-ci
      params:
        submodules: none
    - get: bosh-bootloader # needed to get latest plan-patches
  - task: merge-bbl-config
    file: routing-release-ci/ci/tasks/merge-bbl-config/task.yml
    params:
      SOURCE1_DIR: plan-patches/bosh-lite-gcp
      SOURCE2_DIR: ci/tasks/bbl-configs/add-parent-dns-lite
      SOURCE3_DIR: ci/tasks/bbl-configs/use-larger-disk-lite-gcp
    input_mapping:
      source1: bosh-bootloader
      source2: routing-release-ci
      source3: routing-release-ci
  - task: bbl-up
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_CONFIG_DIR: .
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      BBL_GCP_REGION: us-west1
      BBL_ENV_NAME: ci-lite
      BBL_STATE_DIR: environments/ci-lite/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
      SKIP_LB_CREATION: true
    input_mapping:
      bbl-state: networking-oss-deployments
      bbl-config: merged-bbl-config
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true

- name: ci-lite-destroy
  serial_groups: [ci-lite]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: networking-oss-deployments
    - get: cf-deployment-concourse-tasks
  - task: destroy-ci-lite
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      BBL_STATE_DIR: environments/ci-lite/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-state: networking-oss-deployments
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true

# INFRASTRUCTURE - batman
- name: batman-setup
  serial_groups: [batman]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: bosh-bootloader
    - get: friday-trigger
      trigger: true
  - task: add-parent-dns
    file: routing-release-ci/ci/tasks/add-parent-dns/task.yml
    params:
      ENVIRONMENT: environments/batman
    input_mapping:
      bbl-state: networking-oss-deployments
  - task: inject-plan-patches
    file: routing-release-ci/ci/tasks/inject-plan-patches/task.yml
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
      PLAN_PATCH_DIR: plan-patches/iso-segs-gcp
    input_mapping:
      bbl-state: updated-bbl-state
      plan-patches: bosh-bootloader
  - task: make-certs
    file: routing-release-ci/ci/tasks/make-certs/task.yml
    params:
      ENVIRONMENT: batman
      ENV_PATH: environments/batman
    input_mapping:
      bbl-state: updated-bbl-state
  - task: setup-batman
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      BBL_GCP_REGION: us-west1
      BBL_LB_CERT: ../lb_certs/cert.pem
      BBL_LB_KEY: ../lb_certs/key.pem
      LB_DOMAIN: batman.routing.cf-app.com
      BBL_ENV_NAME: batman
      BBL_STATE_DIR: environments/batman/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-config: updated-bbl-state
      bbl-state: updated-bbl-state
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true
  - task: add-credhub-value
    file: routing-release-ci/ci/tasks/add-credhub-value/task.yml
    params:
      ENVIRONMENT: batman
      NAME: /bosh-batman/cf/datadog_api_key
      VALUE: ((datadog_api_key))

- name: batman-deploy-cf
  serial_groups: [batman]
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
      trigger: true
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release
      trigger: true
      passed:
      - routing-release-unit
    - get: routing-release-ci
      params:
        submodules: none
  - task: upload-lb-cert-to-credhub
    file: routing-release-ci/ci/tasks/set-cert-in-credhub/task.yml
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
      CERTIFICATE_FILE: environments/batman/lb_certs/cert.pem
      CREDHUB_KEY: /bosh-batman/cf/lb_cert
    input_mapping:
      bbl-state: networking-oss-tools
      cert-directory: networking-oss-deployments
  - task: merge-ops-files
    file: routing-release-ci/ci/tasks/merge-ops-files/task.yml
    params:
      ENVIRONMENT: batman
  - task: deploy-batman-with-created-routing
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      release: routing-release
      ops-files: merged-operations
      vars-files: we-dont-use-vars-files
    params:
      SYSTEM_DOMAIN: batman.routing.cf-app.com
      OPS_FILES: |
        use-compiled-releases.yml
        update-watch.yml
        syslog.yml
        routing-acceptance-tests.yml
        routing-smoke-tests.yml
        test/add-persistent-isolation-segment-diego-cell.yml
        test/add-persistent-isolation-segment-router.yml
        add-persistent-isolation-segment-router-ca-certs.yml
        tls-pem.yml
        add-cipher-suites.yml
        smoke-tests.yml
        xfcc.yml
        isolation-in-z3.yml
        backup-and-restore/enable-backup-restore.yml
        disable-bbr-non-routing.yml
        enable-locket-isolated-diego.yml
        create-indicator-protocol-uaa-client.yml
        add-lb-ca-cert.yml
      BBL_STATE_DIR: environments/batman/bbl-state
  - task: create-isolation-segment
    file: routing-release-ci/ci/tasks/create-isolation-segment/task.yml
    params:
      ENVIRONMENT: batman
      ISO_SEG_NAME: "persistent_isolation_segment"

- name: batman-deploy-and-run-cipher-suite-tests
  serial_groups:
  - batman
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: release-dir
      resource: cipher-test-release
      trigger: true
    - get: routing-release
      passed: [batman-deploy-cf]
      trigger: true
    - get: gcp-stemcell-xenial
  - task: generate-cipher-manifest
    file: routing-release-ci/ci/tasks/generate-cipher-manifest/task.yml
    params:
      CIPHERS: "ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384"
      ENVIRONMENT: batman
  - task: create-release-tarball
    file: routing-release-ci/ci/tasks/create-release-tarball/task.yml
  - task: deploy-run-errand
    file: routing-release-ci/ci/tasks/run-cipher-suite/task.yml
    input_mapping:
      gcp-stemcell: gcp-stemcell-xenial
    params:
      ENVIRONMENT: batman
      DEPLOYMENT: cipher
      MANIFEST: cipher-manifest/cipher.yml
      RELEASES_DIR: "release-tarball/*.tgz"
      STEMCELL_REGEX: gcp-stemcell/*.tgz
    ensure:
      task: delete-cipher-deployment
      file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
      input_mapping:
        bbl-state: networking-oss-deployments
      params:
        DEPLOYMENT_NAME: cipher
        BBL_STATE_DIR: environments/batman/bbl-state



- name: batman-cats
  serial_groups: [batman]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: routing-release-ci
      params:
        submodules: none
    - get: cf-acceptance-tests
    - get: cf-deployment
      passed: [batman-cf-smoke-and-indicator-protocol-tests]
      trigger: true
    - get: networking-oss-tools
      passed: [batman-cf-smoke-and-indicator-protocol-tests]
    - get: networking-oss-deployments
      passed: [batman-cf-smoke-and-indicator-protocol-tests]
    - get: cf-deployment-concourse-tasks
    - get: routing-release
      passed: [batman-cf-smoke-and-indicator-protocol-tests]
      trigger: true
  - task: create-integration-config
    file: routing-release-ci/ci/tasks/create-integration-configs/task.yml
    params:
      ENVIRONMENT: batman
      ISO_SEG_NAME: "persistent_isolation_segment"
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      integration-configs: created-integration-configs
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
      CATS_INTEGRATION_CONFIG_FILE: cats_integration_config.json
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
  - task: run-cats
    input_mapping:
      integration-config: updated-integration-configs
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    params:
      CONFIG_FILE_PATH: cats_integration_config.json

- name: batman-cf-smoke-and-indicator-protocol-tests
  serial_groups: [batman]
  plan:
  - in_parallel:
    - get: routing-release
      passed: [batman-deploy-cf]
      trigger: true
    - get: routing-release-ci
      params:
        submodules: none
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-tools
      passed: [batman-deploy-cf]
    - get: networking-oss-deployments
      passed: [batman-deploy-cf]
    - get: cf-smoke-tests-release
    - get: cf-deployment
      passed: [batman-deploy-cf]
      trigger: true
    - get: indicator-protocol-release
      params:
        globs:
        - indicator-verification-linux64*
  - task: create-integration-config
    file: routing-release-ci/ci/tasks/create-integration-configs/task.yml
    params:
      ENVIRONMENT: batman
      ISO_SEG_NAME: "persistent_isolation_segment"
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      integration-configs: created-integration-configs
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
      CATS_INTEGRATION_CONFIG_FILE: cats_integration_config.json
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
  - task: run-cf-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: smoke-tests
  - task: indicator-protocol-test
    file: routing-release-ci/ci/tasks/indicator-protocol-test/task.yml
    params:
      ENVIRONMENT: batman

- name: batman-drats
  serial_groups: [batman]
  plan:
  - get: routing-release
    passed: [batman-cf-smoke-and-indicator-protocol-tests]
    trigger: true
  - get: routing-release-ci
    params:
      submodules: none
  - get: networking-oss-deployments
  - get: networking-oss-tools
  - get: bbr-binary-release
  - get: disaster-recovery-acceptance-tests
  - get: cf-deployment
    trigger: true
    passed: [batman-cf-smoke-and-indicator-protocol-tests]
  - task: create-drats-config
    file: routing-release-ci/ci/tasks/create-drats-config/task.yml
    params:
      ENVIRONMENT: batman
      ENV_PATH: networking-oss-deployments/environments/batman
  - task: run-disaster-recovery-acceptance-tests
    file: disaster-recovery-acceptance-tests/ci/drats-with-integration-config/task.yml
    input_mapping:
      drats-integration-config: created-drats-config
    privileged: true
    params:
      CONFIG_FILE_PATH: drats_integration_config.json
      DEFAULT_TIMEOUT_MINS: 90

- name: batman-rats
  serial_groups: [batman]
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - in_parallel:
      - get: routing-release-ci
        params:
          submodules: none
      - get: networking-oss-deployments
        passed: [batman-cf-smoke-and-indicator-protocol-tests]
      - get: networking-oss-tools
        passed: [batman-cf-smoke-and-indicator-protocol-tests]
      - get: cf-deployment
        trigger: true
        passed: [batman-cf-smoke-and-indicator-protocol-tests]
      - get: routing-release
        passed: [batman-cf-smoke-and-indicator-protocol-tests]
        trigger: true
      - get: cf-deployment-concourse-tasks
    - task: create-integration-config
      file: routing-release-ci/ci/tasks/create-integration-configs/task.yml
      params:
        ENVIRONMENT: batman
        ISO_SEG_NAME: "persistent_isolation_segment"
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      input_mapping:
        bbl-state: networking-oss-deployments
        integration-configs: created-integration-configs
      params:
        BBL_STATE_DIR: environments/batman/bbl-state
        RATS_INTEGRATION_CONFIG_FILE: rats_integration_config.json
        GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    - task: run-rats
      input_mapping:
        integration-config: updated-integration-configs
      params:
        CONFIG_FILE_PATH: rats_integration_config.json
        GINKGO_ARGS: "-v"
      file: routing-release-ci/ci/tasks/run-rats/task.yml

- name: batman-syslog-test
  serial_groups: [batman]
  plan:
  - get: routing-release
    passed: [batman-deploy-cf]
    trigger: true
  - get: networking-oss-deployments
  - get: networking-oss-tools
  - get: routing-release-ci
    params:
      submodules: none
  - get: cf-deployment
    passed: [batman-deploy-cf]
    trigger: true
  - task: syslog-test
    file: routing-release-ci/ci/tasks/syslog-test/task.yml
    params:
      ENVIRONMENT: batman

- name: batman-bosh-cleanup
  serial_groups: [batman]
  plan:
  - get: networking-oss-deployments
    passed: [batman-cats]
    trigger: true
  - get: networking-oss-tools
    passed: [batman-cats]
  - get: cf-deployment-concourse-tasks
  - task: cleanup-artifacts
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
    input_mapping:
      bbl-state: networking-oss-deployments

- name: batman-destroy
  serial_groups: [batman]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: cf-deployment-concourse-tasks
  - task: destroy-batman
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: environments/batman/bbl-state
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-state: networking-oss-deployments
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true

- name: batman-delete-deployment
  serial_groups: [batman]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-tools
    - get: networking-oss-deployments
    - get: routing-release
  - task: delete-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: cf
      BBL_STATE_DIR: environments/batman/bbl-state

- name: orinoco-http-perf-tests
  serial: true
  plan:
  - in_parallel:
    - get: routing-release-ci
      params:
        submodules: none
    - get: cf-deployment-concourse-tasks
    - get: two-hours
      trigger: true
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: cf-deployment
    - get: routing-release
      passed:
      - routing-release-unit
      trigger: true
    - get: routing-perf-release
      trigger: true
  - task: upload-latest-perf
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: routing-perf-release
    params:
      BBL_STATE_DIR: environments/orinoco/bbl-state
  - task: upload-latest-routing
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: routing-release
    params:
      BBL_STATE_DIR: environments/orinoco/bbl-state
  - task: deploy-gorouter-and-perf
    file: routing-release-ci/ci/tasks/bosh2-command/task.yml
    params:
      NUMBER_OF_RUNS: 1
      ENVIRONMENT: orinoco
      DEPLOYMENT: gorouter-standalone-orinoco
      COMMAND: 'deploy routing-release-ci/ci/manifests/gorouter-standalone-orinoco.yml 
      --vars-store /tmp/temp-deployment-vars.yml 
      -v system_domain="orinoco.cf-app.com" 
      --no-redact --non-interactive'
    ensure:
      task: cleanup
      file: routing-release-ci/ci/tasks/bosh2-command/task.yml
      params:
        NUMBER_OF_RUNS: 1
        ENVIRONMENT: orinoco
        DEPLOYMENT: gorouter-standalone-orinoco
        COMMAND: 'clean-up --non-interactive'
  - task: sleep-until-route-populates
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: cloudfoundry/cf-routing-pipeline
      run:
        path: sleep
        args:
        - 30
  - task: http-perf-run
    file: routing-release-ci/ci/tasks/bosh2-command/task.yml
    params:
      ENVIRONMENT: orinoco
      NUMBER_OF_RUNS: 9
      DEPLOYMENT: gorouter-standalone-orinoco
      COMMAND: 'run-errand http_performance_tests --keep-alive --download-logs'
    ensure:
      task: final-run-and-cleanup-errand-vm
      file: routing-release-ci/ci/tasks/bosh2-command/task.yml
      params:
        ENVIRONMENT: orinoco
        NUMBER_OF_RUNS: 1
        DEPLOYMENT: gorouter-standalone-orinoco
        COMMAND: 'run-errand http_performance_tests --download-logs'

# INFRASTRUCTURE - orinoco
- name: orinoco-setup
  serial_groups: [orinoco]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: bosh-bootloader
    - get: friday-trigger
      trigger: true
  - task: make-certs
    file: routing-release-ci/ci/tasks/make-certs/task.yml
    params:
      ENVIRONMENT: orinoco
      ENV_PATH: environments/orinoco
    input_mapping:
      bbl-state: networking-oss-deployments
  - task: setup-orinoco
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: aws
      BBL_AWS_ACCESS_KEY_ID: ((orinoco_aws_access_key_id))
      BBL_AWS_SECRET_ACCESS_KEY: ((orinoco_aws_secret_access_key))
      BBL_AWS_REGION: us-east-1
      BBL_LB_CERT: ../lb_certs/cert.pem
      BBL_LB_KEY: ../lb_certs/key.pem
      LB_DOMAIN: orinoco.routing.cf-app.com
      BBL_ENV_NAME: orinoco
      BBL_STATE_DIR: environments/orinoco/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-config: updated-bbl-state
      bbl-state: updated-bbl-state
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true
  - task: add-credhub-value
    file: routing-release-ci/ci/tasks/add-credhub-value/task.yml
    params:
      ENVIRONMENT: orinoco
      NAME: /bosh-orinoco/gorouter-standalone-orinoco/datadog_api_key
      VALUE: ((datadog_api_key))

- name: orinoco-destroy
  serial_groups: [orinoco]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: networking-oss-deployments
    - get: cf-deployment-concourse-tasks
  - task: destroy-orinoco
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: environments/orinoco/bbl-state
      BBL_AWS_ACCESS_KEY_ID: ((orinoco_aws_access_key_id))
      BBL_AWS_SECRET_ACCESS_KEY: ((orinoco_aws_secret_access_key))
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-state: networking-oss-deployments
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true

- name: orinoco-delete-deployment
  serial_groups: [orinoco]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: routing-release
  - task: delete-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: gorouter-standalone-1
      BBL_STATE_DIR: environments/orinoco/bbl-state

- name: diana-tcp-perf-tests
  serial_groups: [diana]
  plan:
  - in_parallel:
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: gcp-stemcell-xenial
      trigger: true
    - get: bpm-release
    - get: bosh-dns-release
    - get: bosh-dns-aliases-release
    - get: postgres-release
    - get: diego-release
    - get: two-hours
      trigger: true
    - get: routing-release
      passed: [routing-release-unit]
      trigger: true
    - get: routing-perf-release
      trigger: true
    - get: cf-deployment-concourse-tasks
  - task: add-credhub-value
    file: routing-release-ci/ci/tasks/add-credhub-value/task.yml
    params:
      ENVIRONMENT: diana
      NAME: /bosh-diana/performance/datadog_api_key
      VALUE: ((datadog_api_key))
  - task: upload-latest-diego
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: diego-release
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
  - task: upload-latest-postgres
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: postgres-release
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
  - task: upload-latest-bosh-dns-aliases
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: bosh-dns-aliases-release
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
  - task: upload-latest-bpm
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: bpm-release
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
  - task: upload-latest-bosh-dns
    file: routing-release-ci/ci/tasks/upload-local-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      local-release: bosh-dns-release
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
  - task: generate-perf-manifest
    file: routing-release-ci/ci/tasks/generate-perf-manifest/task.yml
    params:
      MANIFEST_PATH: routing-release-ci/ci/manifests/diana-perf.yml
  - task: create-perf-release-tarball
    file: routing-release-ci/ci/tasks/create-release-tarball/task.yml
    input_mapping:
      release-dir: routing-perf-release
    output_mapping:
      release-tarball: perf-release-tarball
  - task: create-routing-release-tarball
    file: routing-release-ci/ci/tasks/create-release-tarball/task.yml
    input_mapping:
      release-dir: routing-release
    output_mapping:
      release-tarball: routing-release-tarball
  - task: generate-bosh-deployment-source-json
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: cloudfoundry/cf-routing-pipeline
      inputs:
      - name: networking-oss-deployments
      outputs:
      - name: bosh-director
      run:
        path: bash
        args:
        - -c
        - |
            set -e -o pipefail
            pushd $(pwd)/networking-oss-deployments/environments/diana/bbl-state
            echo '{}' | jq --arg target "$(bbl director-address)" \
              --arg caCert "$(bbl director-ca-cert)" \
              --arg client "$(bbl director-username)" \
              --arg clientSecret "$(bbl director-password)" \
              --arg jumpboxURL "$(bbl jumpbox-address):22" \
              --arg jumpboxSSHKey "$(bbl ssh-key)" \
              '{
              "target": $target,
              "ca_cert": $caCert,
              "client": $client,
              "client_secret": $clientSecret,
              "deployment": "performance",
              "jumpbox_url": $jumpboxURL,
              "jumpbox_ssh_key": $jumpboxSSHKey
            }' > source.json
            popd
            cp $(pwd)/networking-oss-deployments/environments/diana/bbl-state/source.json $(pwd)/bosh-director/
  # deploy
  - put: diana-tcp-perf-deployment
    params:
      source_file: bosh-director/source.json
      manifest: perf-manifest/diana-perf.yml
      releases:
      - routing-release-tarball/*.tgz
      - perf-release-tarball/*.tgz
      stemcells: [gcp-stemcell-xenial/*.tgz]
      cleanup: true
  - task: sleep-until-route-populates
    config:
      platform: linux
      image_resource:
        type: docker-image
        source:
          repository: cloudfoundry/cf-routing-pipeline
      run:
        path: sleep
        args:
        - 30
  - task: tcp-perf-run
    file: routing-release-ci/ci/tasks/bosh2-command/task.yml
    params:
      NUMBER_OF_RUNS: 4
      ENVIRONMENT: diana
      DEPLOYMENT: performance
      COMMAND: 'run-errand tcp_performance_tests --keep-alive --download-logs'
    ensure:
      task: final-run-and-cleanup-errand-vm
      file: routing-release-ci/ci/tasks/bosh2-command/task.yml
      params:
        NUMBER_OF_RUNS: 1
        ENVIRONMENT: diana
        DEPLOYMENT: performance
        COMMAND: 'run-errand tcp_performance_tests --download-logs'

- name: diana-cleanup
  serial_groups: [diana]
  plan:
  - get: networking-oss-deployments
    trigger: true
    passed: [diana-tcp-perf-tests]
  - get: cf-deployment-concourse-tasks
  - task: cleanup-artifacts
    file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
    input_mapping:
      bbl-state: networking-oss-deployments
  - task: delete-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: performance
      BBL_STATE_DIR: environments/diana/bbl-state

# BOSH LITE DEPLOY AND TEST - ci-lite
- name: ci-lite-deploy-cf
  serial: true
  serial_groups: [ci-lite]
  plan:
  - in_parallel:
    - get: we-dont-use-vars-files
      submodules: none
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment
      trigger: true
    - get: routing-release-ci
      params:
        submodules: none
    - get: routing-release
      trigger: true
      passed:
      - routing-release-unit
  - task: upload-lb-cert-to-credhub
    file: routing-release-ci/ci/tasks/set-cert-in-credhub/task.yml
    params:
      BBL_STATE_DIR: environments/ci-lite/bbl-state
      CERTIFICATE_FILE: environments/ci-lite/lb_certs/cert.pem
      CREDHUB_KEY: /bosh-ci-lite/cf/lb_cert
    input_mapping:
      bbl-state: networking-oss-deployments
      cert-directory: networking-oss-deployments
  - task: merge-ops-files
    file: routing-release-ci/ci/tasks/merge-ops-files/task.yml
    params:
      ENVIRONMENT: ci-lite
  - task: deploy-ci-lite-with-created-routing
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      release: routing-release
      ops-files: merged-operations
      vars-files: we-dont-use-vars-files
    params:
      SYSTEM_DOMAIN: ci-lite.routing.cf-app.com
      OPS_FILES: |
        use-compiled-releases.yml
        bosh-lite.yml
        use-postgres.yml
        routing-acceptance-tests.yml
        routing-smoke-tests.yml
        add-lb-ca-cert.yml
      BBL_STATE_DIR: environments/ci-lite/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
      BOSH_LITE: true
  - task: bosh-cleanup
    file: routing-release-ci/ci/tasks/bosh2-command/task.yml
    params:
      ENVIRONMENT: ci-lite
      DEPLOYMENT: cf
      COMMAND: -n clean-up --all

- name: ci-lite-cats
  serial_groups: [ci-lite]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: routing-release-ci
      params:
        submodules: none
    - get: cf-acceptance-tests
    - get: cf-deployment
      trigger: true
      passed: [ci-lite-deploy-cf]
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: cf-deployment-concourse-tasks
    - get: routing-release
      passed: [ci-lite-deploy-cf]
      trigger: true
  - task: create-integration-configs
    file: routing-release-ci/ci/tasks/create-integration-configs/task.yml
    params:
      ENVIRONMENT: ci-lite
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      integration-configs: created-integration-configs
    params:
      BBL_STATE_DIR: environments/ci-lite/bbl-state
      CATS_INTEGRATION_CONFIG_FILE: cats_integration_config.json
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
  - task: run-cats
    input_mapping:
      integration-config: updated-integration-configs
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    params:
      CONFIG_FILE_PATH: cats_integration_config.json
      NODES: 4

- name: ci-lite-rats
  serial_groups: [ci-lite]
  build_logs_to_retain: 100
  plan:
  - timeout: 4h
    do:
    - in_parallel:
      - get: routing-release-ci
        params:
          submodules: none
      - get: networking-oss-deployments
      - get: networking-oss-tools
      - get: cf-deployment
        trigger: true
        passed: [ci-lite-deploy-cf]
      - get: routing-release
        passed: [ci-lite-deploy-cf]
        trigger: true
      - get: cf-deployment-concourse-tasks
        passed: [ci-lite-deploy-cf]
    - task: create-integration-configs
      file: routing-release-ci/ci/tasks/create-integration-configs/task.yml
      params:
        ENVIRONMENT: ci-lite
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      input_mapping:
        bbl-state: networking-oss-deployments
        integration-configs: created-integration-configs
      params:
        BBL_STATE_DIR: environments/ci-lite/bbl-state
        RATS_INTEGRATION_CONFIG_FILE: rats_integration_config.json
        GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    - task: run-rats
      input_mapping:
        integration-config: updated-integration-configs
      params:
        CONFIG_FILE_PATH: rats_integration_config.json
        GINKGO_ARGS: "-v"
      file: routing-release-ci/ci/tasks/run-rats/task.yml

- name: diana-setup
  serial_groups: [diana]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: bosh-bootloader
    - get: friday-trigger
      trigger: true
  - task: add-parent-dns
    file: routing-release-ci/ci/tasks/add-parent-dns/task.yml
    params:
      ENVIRONMENT: diana
    input_mapping:
      bbl-state: networking-oss-deployments
  - task: setup-diana
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      BBL_GCP_REGION: us-west1
      BBL_LB_CERT: ../lb_certs/cert.pem
      BBL_LB_KEY: ../lb_certs/key.pem
      LB_DOMAIN: diana.routing.cf-app.com
      BBL_ENV_NAME: diana
      BBL_STATE_DIR: environments/diana/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-state: updated-bbl-state
      bbl-config: updated-bbl-state
    ensure:
      put: deployments-routing
      params:
        repository: updated-bbl-state
        rebase: true

- name: diana-destroy
  serial_groups: [diana]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: cf-deployment-concourse-tasks
  - task: destroy-diana
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: environments/diana/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
    input_mapping:
      bbl-state: networking-oss-deployments
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true

- name: jubilee-bbl-up
  serial_groups: [jubilee]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: bosh-bootloader
  - task: merge-bbl-config
    file: routing-release-ci/ci/tasks/merge-bbl-config/task.yml
    params:
      SOURCE1_DIR: ci/tasks/bbl-configs/add-parent-dns-full
    input_mapping:
      source1: routing-release-ci
  - task: make-certs
    file: routing-release-ci/ci/tasks/make-certs/task.yml
    params:
      ENVIRONMENT: jubilee
      ENV_PATH: environments/jubilee
    input_mapping:
      bbl-state: networking-oss-deployments
  - task: setup-jubilee
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    input_mapping:
      bbl-state: updated-bbl-state
      bbl-config: merged-bbl-config
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      BBL_GCP_REGION: us-central1
      BBL_LB_CERT: ../lb_certs/cert.pem
      BBL_LB_KEY: ../lb_certs/key.pem
      LB_DOMAIN: jubilee.routing.cf-app.com
      BBL_ENV_NAME: jubilee
      BBL_STATE_DIR: environments/jubilee/bbl-state
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
      BBL_CONFIG_DIR: "."
    ensure:
      put: networking-oss-deployments
      params:
        repository: updated-bbl-state
        rebase: true

- name: jubilee-no-downtime
  serial_groups: [jubilee]
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: cf-deployment-release-latest
      trigger: true
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: routing-release-ci
      params:
        submodules: none
    - get: cf-smoke-tests-release
    - get: zero-downtime-release
    - get: routing-release
      trigger: true
      passed: [routing-release-unit]
  - task: merge-ops-files
    file: routing-release-ci/ci/tasks/merge-ops-files/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-latest
    params:
      ENVIRONMENT: jubilee
  - task: delete-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: cf
      BBL_STATE_DIR: environments/jubilee/bbl-state
  - task: deploy-jubilee-with-base-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      ops-files: merged-operations
      vars-files: we-dont-use-vars-files
      cf-deployment: cf-deployment-release-latest
    params:
      SYSTEM_DOMAIN: jubilee.routing.cf-app.com
      OPS_FILES: &jubilee-ops-files |
        use-compiled-releases.yml
      BBL_STATE_DIR: environments/jubilee/bbl-state
  - task: deploy-jubilee-cf
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-latest
      bbl-state: networking-oss-deployments
      ops-files: merged-operations
      vars-files: we-dont-use-vars-files
    params:
      SYSTEM_DOMAIN: jubilee.routing.cf-app.com
      OPS_FILES: *jubilee-ops-files
      BBL_STATE_DIR: environments/jubilee/bbl-state
  - task: create-integration-config
    file: routing-release-ci/ci/tasks/create-integration-configs/task.yml
    params:
      ENVIRONMENT: jubilee
      ENABLE_ISOLATION_SEGMENT_TESTS: false
  - task: update-integration-configs
    file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
      integration-configs: created-integration-configs
    params:
      BBL_STATE_DIR: environments/jubilee/bbl-state
      CATS_INTEGRATION_CONFIG_FILE: cats_integration_config.json
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
  - task: run-cf-smoke-tests
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    attempts: 3
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      BBL_STATE_DIR: environments/jubilee/bbl-state
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: smoke-tests
  - task: setup-jubilee-env
    file: routing-release-ci/ci/tasks/setup-cf-env/task.yml
    params:
      SYSTEM_DOMAIN: routing.cf-app.com
      ENVIRONMENT: jubilee
      CF_ORG: zdorg
      CF_SPACE: zdspace
  - in_parallel:
    - task: deploy-zero-downtime-backends
      file: routing-release-ci/ci/tasks/deploy-zero-downtime-backends/task.yml
      params:
        ENVIRONMENT: jubilee
    - task: create-http-app
      file: routing-release-ci/ci/tasks/create-zd-app/task.yml
      attempts: 3
      params:
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
        CF_APP_NAME: drroute
        CF_ORG: zdorg
        CF_SPACE: zdspace
        ENVIRONMENT: jubilee
    - task: create-tcp-app
      file: routing-release-ci/ci/tasks/create-zd-app/task.yml
      attempts: 3
      params:
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
        CF_APP_NAME: drtcproute
        CF_ORG: zdorg
        CF_SPACE: zdspace
        ENVIRONMENT: jubilee
        TCP: true
  - in_parallel:
    - task: start-zero-downtime-http-test
      file: routing-release-ci/ci/tasks/start-zero-downtime-test/task.yml
      params:
        CF_APP_NAME: drroute
        CF_ORG: zdorg
        CF_SPACE: zdspace
        ENVIRONMENT: jubilee
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
    - task: start-zero-downtime-tcp-test
      file: routing-release-ci/ci/tasks/start-zero-downtime-test/task.yml
      params:
        CF_APP_NAME: drtcproute
        CF_ORG: zdorg
        CF_SPACE: zdspace
        ENVIRONMENT: jubilee
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
        TCP: true
  - task: merge-ops-files
    file: routing-release-ci/ci/tasks/merge-ops-files/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-latest
    output_mapping:
      merged-operations: merged-upgrade-operations
    params:
      ENVIRONMENT: jubilee
  - task: deploy-jubilee-with-created-routing
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping:
      cf-deployment: cf-deployment-release-latest
      bbl-state: networking-oss-deployments
      release: routing-release
      ops-files: merged-upgrade-operations
      vars-files: we-dont-use-vars-files
    params:
      SYSTEM_DOMAIN: jubilee.routing.cf-app.com
      OPS_FILES: *jubilee-ops-files
      BBL_STATE_DIR: environments/jubilee/bbl-state
  - in_parallel:
    - task: cleanup-artifacts
      file: cf-deployment-concourse-tasks/bosh-cleanup/task.yml
      params:
        BBL_STATE_DIR: environments/jubilee/bbl-state
      input_mapping:
        bbl-state: networking-oss-deployments
    - task: stop-zero-downtime-http-test
      file: routing-release-ci/ci/tasks/stop-zero-downtime-test/task.yml
      params:
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
        CF_APP_NAME: drroute
    - task: stop-zero-downtime-tcp-test
      file: routing-release-ci/ci/tasks/stop-zero-downtime-test/task.yml
      params:
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
        CF_APP_NAME: drtcproute
  - in_parallel:
    - task: check-zero-downtime-test-results
      file: routing-release-ci/ci/tasks/check-zero-downtime-test-results/task.yml
      params:
        CF_APP_DOMAIN: jubilee.routing.cf-app.com
        CF_APP_NAME: drroute
    - try:
        task: check-zero-downtime-tcp-test-results
        file: routing-release-ci/ci/tasks/check-zero-downtime-test-results/task.yml
        params:
          CF_APP_DOMAIN: jubilee.routing.cf-app.com
          CF_APP_NAME: drtcproute
  - task: delete-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: cf
      BBL_STATE_DIR: environments/jubilee/bbl-state

- name: deliver-stories
  serial: true
  plan:
  - get: routing-release
    trigger: true
    passed:
      - batman-cats
      - batman-rats
      - batman-drats
      - batman-syslog-test
      - ci-lite-rats
      - ci-lite-cats
      - diana-tcp-perf-tests
      - orinoco-http-perf-tests
      - jubilee-no-downtime
  - put: cf-diego-networking-tracker
    params:
      repos:
      - routing-release

- name: bump-to-rc
  serial: true
  plan:
  - get: routing-release
    passed:
      - deliver-stories
    trigger: true
  - put: routing-release-rc
    params:
      repository: routing-release

- name: jubilee-destroy
  serial_groups: [jubilee]
  build_logs_to_retain: 100
  plan:
  - in_parallel:
    - get: networking-oss-deployments
    - get: networking-oss-tools
    - get: cf-deployment-concourse-tasks
    - get: routing-release
  - task: delete-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: cf
      BBL_STATE_DIR: environments/jubilee/bbl-state
  - task: delete-zero-downtime-deployment
    file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
    input_mapping:
      bbl-state: networking-oss-deployments
    params:
      DEPLOYMENT_NAME: zero-downtime
      BBL_STATE_DIR: environments/jubilee/bbl-state
  - task: destroy-jubilee
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: environments/jubilee/bbl-state
      BBL_GCP_SERVICE_ACCOUNT_KEY: ((shared_gcp_account_creds))
      GIT_COMMIT_EMAIL: cf-routing-eng@pivotal.io
    input_mapping:
      bbl-state: networking-oss-deployments
    ensure:
      do:
      - put: networking-oss-deployments
        params:
          repository: updated-bbl-state
          rebase: true
